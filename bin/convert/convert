#!/usr/bin/env bash

##
# Runtime Options
##

set -o errexit  # Stop on command failures.
set -o nounset  # Stop when there are undefined variables.
set -o pipefail # Stop when a command in a pipe failes.


##
# Parameters
##

readonly SrcDir="${1:-"$HOME/.lablog"}"
readonly DstDir="${2:-"lablog"}"


##
# Functions
##

convert_main() {
  local srcdir="${1:-""}"
  local dstdir="${2:-""}"

  if [[ -z "${srcdir}" ]]; then
    echo "srcdir can not be empty."
    return 1
  fi

  if [[ -z "${dstdir}" ]]; then
    echo "dstdir can not be empty."
    return 1
  fi

  for filename in $(find "${srcdir}" -type f -name '*.csv'); do
    echo "filename: ${filename}" > /dev/null

    local basename="$(basename "${filename}")"

    local newbasename="${dstdir}/${basename%.*}"
    echo "newbasename: ${newbasename}" > /dev/null

    local newfilename="$(echo "${newbasename}" | tr '.' '/').csv"
    echo "newfilename: ${newfilename}" > /dev/null

    local newdirname="$(dirname "${newfilename}")"
    echo "newdirname: ${newdirname}" > /dev/null

    mkdir -p "${newdirname}"
    cp "${filename}" "${newfilename}"
  done
}

##
# Entry Point
##

convert_main "${SrcDir}" "${DstDir}"
